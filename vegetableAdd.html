<!DOCTYPE html>
<html>
<head>
    <title>用戶添加</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8"/>

    <link rel="icon" type="image/ico" href="assets/images/favicon.ico" />
    <!-- Bootstrap -->
    <link rel="stylesheet" href="assets/css/vendor/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/bootstrapValidator.min.css">
    <link href="font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/vendor/animate/animate.css" >
    <link type="text/css" rel="stylesheet" media="all" href="assets/js/vendor/mmenu/css/jquery.mmenu.all.css" >
    <link rel="stylesheet" href="assets/js/vendor/videobackground/css/jquery.videobackground.css">
    <link rel="stylesheet" href="assets/css/vendor/bootstrap-checkbox.css">
    <link rel="stylesheet" href="assets/css/vendor/bootstrap/bootstrap-dropdown-multilevel.css" >

    <link rel="stylesheet" href="assets/js/vendor/chosen/css/chosen.min.css">
    <link rel="stylesheet" href="assets/js/vendor/chosen/css/chosen-bootstrap.css">

    <link href="assets/css/minimal.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="../../../../../../oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="../../../../../../oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
</head>
<body class="bg-3">

<!-- Preloader -->
<div class="mask"><div id="loader"></div></div>
<!--/Preloader -->

<!-- Wrap all page content here -->
<div id="wrap">

    <!-- Make page fluid -->
    <div class="row">

        <div id="menuContainer">

        </div>

        <!-- 内容开始 -->
        <div id="content" class="col-md-12">

            <!-- 头部开始 -->
            <div class="pageheader">
                <h2>蔬菜信息</h2>
            </div>
            <!-- 头部结束 -->

            <!-- 主要内容开始 -->
            <div class="main">

                <!-- row -->
                <div class="row">
                    <!-- col 12 -->
                    <div class="col-md-12">

                        <!-- tile -->
                        <section class="tile color transparent-black">

                            <!-- tile header -->
                            <div class="tile-header">
                                <h1>填写蔬菜信息</h1>
                                <div class="controls">
                                    <a href="#" class="minimize"><i class="fa fa-chevron-down"></i></a>
                                    <a href="#" class="refresh"><i class="fa fa-refresh"></i></a>
                                    <a href="#" class="remove"><i class="fa fa-times"></i></a>
                                </div>
                            </div>
                            <!-- /tile header -->

                            <!-- 蔬菜信息开始 -->
                            <form id="myForm">
                                <div class="tile-body">
                                <!--行开始-->
                                <div class="row">
                                    <!--左边列开始（图片）-->
                                    <div class="col-md-3">
                                        <img class="img" src="" width="298" height="223">
                                        <input type="file" class="form-control" id="vegetablePhoto" name="vegetablePhoto">
                                    </div>
                                    <!--左边列结束（图片）-->

                                    <!--右边列开始-->
                                    <div class="col-md-9">
                                        <!--右边第一行开始-->
                                        <div class="row form-horizontal">
                                            <div class="form-group col-md-6">
                                                <label class="col-sm-3 control-label" style="margin-left: -16px;">蔬菜名称</label>
                                                <div class="col-sm-8">
                                                    <input v-model="params.vname" type="text" class="form-control" name="vName" placeholder="请输入">
                                                </div>
                                            </div>
                                            <div class="form-group col-md-6">
                                                <label class="col-sm-3 control-label">蔬菜别称</label>
                                                <div class="col-sm-8">
                                                    <input v-model="params.vnickname" type="text" class="form-control" name="vNickName" placeholder="请输入">
                                                </div>
                                            </div>
                                        </div>
                                        <!--右边第一行结束-->

                                        <div class="row form-horizontal">
                                            <div class="form-group col-md-6">
                                                <label class="col-sm-3 control-label" style="margin-left: -16px;">类别</label>
                                                <div class="col-sm-8">
                                                    <select v-model="params.typeId" class="form-control" name="typeId" style="width: 200px">
                                                        <option value="">请选择类别</option>
                                                        <option value="1">菌类</option>
                                                        <option value="2">叶类</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="form-group col-md-6">
                                                <label class="col-sm-3 control-label">生长时间</label>
                                                <div class="col-sm-8">
                                                    <input v-model="params.growingTime" type="text" class="form-control" name="growingTime" placeholder="请输入">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row form-horizontal">
                                            <div class="form-group col-md-10">
                                                <label class="col-sm-2 control-label" style="margin-left: -32px;">食用方式</label>
                                                <div class="col-sm-8">
                                                    <textarea v-model="params.eatWay" class="form-control" name="eatWay" rows="2"></textarea>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row form-horizontal">
                                            <div class="form-group col-md-10">
                                                <label class="col-sm-2 control-label" style="margin-left: -32px;">营养成分</label>
                                                <div class="col-sm-8">
                                                    <textarea  v-model="params.nutrients" class="form-control" name="nutrients" rows="4"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--右边列结束-->


                                </div>
                                <!--行结束-->

                                <!--行开始-->
                                <div class="row">

                                    <div class="col-md-6">

                                        <div class="row form-horizontal">
                                            <div class="form-group col-md-11" style="margin-left: 0px;">
                                                <label>主要价值</label>
                                                <div>
                                                    <textarea v-model="params.mainValue" class="form-control" name="mainValue" rows="6"></textarea>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row form-horizontal">
                                            <div class="form-group col-md-11" style="margin-left: 0px;">
                                                <label>形态特征</label>
                                                <div>
                                                    <textarea v-model="params.characteristics" class="form-control" name="characteristics" rows="6"></textarea>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row form-horizontal">
                                            <div class="form-group col-md-11" style="margin-left: 0px;">
                                                <label>主要品种</label>
                                                <div>
                                                    <textarea v-model="params.varieties" class="form-control" name="varieties" rows="6"></textarea>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row form-horizontal">
                                            <div class="form-group col-md-11" style="margin-left: 0px;">
                                                <label>生长环境</label>
                                                <div>
                                                    <textarea v-model="params.growingEnvironment" class="form-control" name="growingEnvironment" rows="6"></textarea>
                                                </div>
                                            </div>
                                        </div>

                                    </div>

                                    <div class="col-md-6">

                                        <div class="row form-horizontal">
                                            <div class="form-group col-md-11" >
                                                <label>植物学史</label>
                                                <div>
                                                    <textarea v-model="params.plantHistory" class="form-control" name="plantHistory" rows="6"></textarea>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row form-horizontal">
                                            <div class="form-group col-md-11" >
                                                <label>分布范围</label>
                                                <div>
                                                    <textarea v-model="params.distribution" class="form-control" name="distribution" rows="6"></textarea>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row form-horizontal">
                                            <div class="form-group col-md-11" >
                                                <label>种植方式</label>
                                                <div>
                                                    <textarea v-model="params.plantingWay" class="form-control" name="plantingWay" rows="6"></textarea>
                                                </div>
                                            </div>
                                        </div>

                                </div>
                                <!--行结束-->
                            </div>
                                <!--行结束-->

                                <div class="row">
                                    <div class="col-md-12 form-group" align="center">
                                        <button type="button" name="submit" @click="submit()" class="btn btn-primary btn-lg margin-bottom-20 saveBtn">保存</button>
                                        <button @click="updateVegetable()" type="button" class="btn btn-primary btn-lg margin-bottom-20 updataBtn">修改</button>
                                        <button type="button" class="btn btn-default btn-lg margin-bottom-20">返回</button>
                                    </div>
                                </div>
                            <!-- 蔬菜信息结束 -->
                            </div>
                            </form>
                        </section>
                        <!-- /tile -->
                    </div>
                    <!-- /col 12 -->
                </div>
                <!-- /row -->
            </div>
            <!-- 主要内容结束 -->

        </div>
        <!-- 内容结束 -->
    </div>
    <!-- Make page fluid-->

</div>
<!-- Wrap all page content end -->



<section class="videocontent" id="video"></section>



<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="assets/js/jquery.js"></script>
<script src="assets/js/vue.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script type="text/javascript" src="assets/js/vendor/bootstrap/bootstrap.min.js"></script>
<script type="text/javascript" src="assets/js/bootstrapValidator.min.js"></script>
<script src="assets/js/vendor/bootstrap/bootstrap-dropdown-multilevel.js" ></script>
<script type="text/javascript" src="assets/js/vendor/mmenu/js/jquery.mmenu.min.js"></script>
<script type="text/javascript" src="assets/js/vendor/sparkline/jquery.sparkline.min.js"></script>
<script type="text/javascript" src="assets/js/vendor/nicescroll/jquery.nicescroll.min.js"></script>
<script type="text/javascript" src="assets/js/vendor/animate-numbers/jquery.animateNumbers.js"></script>
<script type="text/javascript" src="assets/js/vendor/videobackground/jquery.videobackground.js"></script>
<script type="text/javascript" src="assets/js/vendor/blockui/jquery.blockUI.js"></script>
<script src="assets/js/vendor/chosen/chosen.jquery.min.js"></script>
<script src="assets/js/vendor/parsley/parsley.min.js" charset="GBK"></script>
<script src="assets/js/minimal.min.js"></script>
<script>
    //页面加载时把导航菜单加载到相应位置
    $("#menuContainer").load("navigationMenu.html");
    //设置菜单缓存
    window.sessionStorage.setItem("menu","userAddMenu");
    $(function () {
        /* 重点是这个位置 */
        $("#vegetablePhoto").change(function() {
            /*在改变照片时，清空以前图片*/
            $(".img").empty();
            var oFReader = new FileReader();
            var file = document.getElementById('vegetablePhoto').files[0];
            oFReader.readAsDataURL(file);
            oFReader.onloadend = function(oFRevent){
                var src = oFRevent.target.result;
                $(".img").attr("src",src);
            }
        });
    });
</script>
<script>

    var vm = new Vue({
       el:"#content",
       data:{
           params:{
               vid:null,
               image:null
           },
       },
       mounted:function(){
           //隐藏修改按钮
           $(".updataBtn").hide();
           //验证表单
           $("#myForm").bootstrapValidator({
               message: 'This value is not valid',
               feedbackIcons: {
                   valid: 'glyphicon glyphicon-ok',
                   invalid: 'glyphicon glyphicon-remove',
                   validating: 'glyphicon glyphicon-refresh'
               },
               fields:{
                   vName: {
                       message: '蔬菜名验证失败',
                       validators:{
                           notEmpty:{
                               message:"蔬菜名不能为空"
                           }
                       }
                   },

                   vNickName:{
                       message:'蔬菜昵称验证失败',
                       validators: {
                           notEmpty: {
                               message:"蔬菜昵称不能为空"
                           }
                       }
                   },

                   //类别
                   typeId: {
                       message:'类别验证失败',
                       validators: {
                           notEmpty: {
                               message:"类别不能为空"
                           }
                       }
                   },

                   //生长时间
                   growingTime:{
                       message:'生长时间验证失败',
                       validators: {
                           notEmpty: {
                               message:"生长时间不能为空"
                           }
                       }
                   },

                   //食用方式
                   eatWay:{
                       message:'食用方式验证失败',
                       validators: {
                           notEmpty: {
                               message:"食用方式不能为空"
                           }
                       }
                   },

                   //营养成分
                   nutrients:{
                       message:'营养成分验证失败',
                       validators: {
                           notEmpty: {
                               message:"营养成分不能为空"
                           }
                       }
                   },

                   //主要价值
                   mainValue:{
                       message:'主要价值验证失败',
                       validators: {
                           notEmpty: {
                               message:"主要价值不能为空"
                           }
                       }
                   },

                   //形态特征
                   characteristics:{
                       message:'形态特征验证失败',
                       validators: {
                           notEmpty: {
                               message:"形态特征不能为空"
                           }
                       }
                   },

                   //主要品种
                   varieties:{
                       message:'主要品种验证失败',
                       validators: {
                           notEmpty: {
                               message:"主要品种不能为空"
                           }
                       }
                   },

                   //生长环境
                   growingEnvironment:{
                       message:'生长环境验证失败',
                       validators: {
                           notEmpty: {
                               message:"生长环境不能为空"
                           }
                       }
                   },

                   //植物学史
                   plantHistory:{
                       message:'植物学史验证失败',
                       validators: {
                           notEmpty: {
                               message:"植物学史不能为空"
                           }
                       }
                   },

                   //分布范围
                   distribution:{
                       message:'分布范围验证失败',
                       validators: {
                           notEmpty: {
                               message:"分布范围不能为空"
                           }
                       }
                   },

                   //种植方式
                   plantingWay:{
                       message:'种植方式验证失败',
                       validators: {
                           notEmpty: {
                               message:"种植方式不能为空"
                           }
                       }
                   }
               },

           });

           this.showVegetable();

       },
       methods:{

           //添加蔬菜信息
           submit:function () {
               //手动验证表单
               $("#myForm").data("bootstrapValidator").validate();
               //获取表单验证状态
               var flag = $("#myForm").data("bootstrapValidator").isValid();
               //如果验证成功则添加用户信息
               if(flag){
                   //1.上传蔬菜图片
                   $.ajax({
                       url:"http://localhost:9000/upload/vegetableUpload",
                       type:"POST",
                       dataType:"json",
                       cache:false,
                       processData:false,
                       contentType:false,
                       data: new FormData($("#myForm")[0]),
                       success:function (data) {
                           if (data.code === 0){
                               //获取上传成功的蔬菜图片名称
                               vm.params.image = "http://localhost:9000/img/vegetable/"+ data.fileName + data.extendedName;
                               //2、添加蔬菜信息
                               $.ajax({
                                   url:"http://localhost:9000/vegetableInfo/insertVegetable",
                                   type: "POST",
                                   dataType: "json",
                                   contentType: 'application/json; charset=UTF-8',
                                   data:JSON.stringify(vm.params),
                                   success:function (data) {
                                       if (data.code === 0){
                                           alert(data.msg);
                                       }else {
                                           alert(data.msg);
                                       }
                                   }
                               });
                           }else {
                               alert(data.msg);
                           }
                       }
                   });
               }else {
                   alert("验证不通过");
               }
           },

           //显示蔬菜信息
           showVegetable:function () {
               if (sessionStorage.getItem("vegetable") !=null){
                   //从缓存里拿到蔬菜详细信息,并放入相应的文本框类
                   this.params = JSON.parse(window.sessionStorage.getItem("vegetable"));
                   //显示图片
                   $(".img").attr("src",this.params.image);
                   //隐藏保存按钮，显示修改按钮
                   $(".saveBtn").hide();
                   $(".updataBtn").show();
               }
           },

           //修改蔬菜信息
           updateVegetable:function () {
               //手动验证表单
               $("#myForm").data("bootstrapValidator").validate();
               //获取表单验证状态
               var flag = $("#myForm").data("bootstrapValidator").isValid();
               //如果验证成功则添加用户信息
               if (flag){
                   //判断用户是否修改了图片
                   var vegetablePhoto = $("#vegetablePhoto").val();
                   //如果没有修改图片，就只修改用户相关信息，不上传图片
                   if( vegetablePhoto == ""){
                       $.ajax({
                           url:"http://localhost:9000/vegetableInfo/updateVegetable",
                           type:"POST",
                           dataType:"json",
                           contentType: 'application/json; charset=UTF-8',
                           data:JSON.stringify(vm.params),
                           success:function (data) {
                               //console.log(data);
                               if (data.code === 0){
                                   alert(data.msg);
                                   window.sessionStorage.removeItem("vegetable");
                                   window.location.href="vegetableQuery.html";
                               }else {
                                   alert(data.msg);
                               }
                           }
                       });
                   }else {
                       /**
                        * 1、如果修改了图片，先要删除本地图片
                        * 2、删除成功后再上传新的图片到本地
                        * 3、然后再修改用户相关信息
                        */
                           //1、删除图片
                       var url = "http://localhost:9000/upload/deleteVegetablePhoto";
                       var args = {
                           "vegetablePhoto":vm.params.image
                       }
                       $.post(url,args,function (data) {
                           if (data.code === 0){
                               //2、上传图片
                               $.ajax({
                                   url:"http://localhost:9000/upload/vegetableUpload",
                                   type:"POST", //请求方式
                                   dataType:"json", //前端发送数据的格式
                                   cache:false, //关闭缓存
                                   processData: false, //默认情况下，processData 的值是 true，其代表以对象的形式上传的数据都会被转换为字符串的形式上传。而当上传文件的时候，则不需要把其转换为字符串，因此要改成false
                                   contentType: false, //上传文件时改为 false
                                   data:new FormData($("#myForm")[0]), //用 Ajax 上传文件，需要使用 FormData 对象来作为数据
                                   success:function (data) {
                                       //console.log(data);
                                       if (data.code === 0){
                                           //alert(data.msg);
                                           //3、修改用户相关信息
                                           //绑定用户图片名称
                                           vm.params.image = "http://localhost:9000/img/vegetable/" + data.fileName + data.extendedName;
                                           $.ajax({
                                               url:"http://localhost:9000/vegetableInfo/updateVegetable",
                                               type:"POST",
                                               dataType:"json",
                                               contentType: 'application/json; charset=UTF-8',
                                               data: JSON.stringify(vm.params),
                                               success:function (data) {
                                                   //console.log(data);
                                                   if (data.code === 0){
                                                       alert(data.msg);
                                                       //清除用户缓存信息
                                                       window.sessionStorage.removeItem("vegetable");
                                                       window.location.href="vegetableQuery.html";
                                                   }else {
                                                       alert(data.msg);
                                                   }
                                               }
                                           });
                                       }else {
                                           alert(data.msg);
                                       }
                                   }
                               });
                           }else {
                               alert(data.msg);
                           }
                       });
                   }
               }
           }

       }

    });

</script>
</body>
</html>
